package combat

import (
	"github.com/genshinsim/gcsim/pkg/core/attributes"
	"github.com/genshinsim/gcsim/pkg/core/info"
)

type reactionBonusSrc interface {
	ReactBonus(atk info.AttackInfo) float64
}

func CalcReactionBaseDmg(lvl int) float64 {
	idx := lvl - 1
	idx = min(idx, 99)
	idx = max(idx, 0)
	return reactionLvlBase[idx]
}

func CalcLunarChargedDmg(lvl int, src reactionBonusSrc, atk info.AttackInfo, em float64) float64 {
	return (1 + ((6 * em) / (2000 + em)) + src.ReactBonus(atk)) * CalcReactionBaseDmg(lvl)
}

func CalcReactionDmg(lvl int, src reactionBonusSrc, atk info.AttackInfo, em float64) (float64, info.Snapshot) {
	snap := info.Snapshot{
		CharLvl: lvl,
	}
	snap.Stats[attributes.EM] = em
	return (1 + ((16 * em) / (2000 + em)) + src.ReactBonus(atk)) * CalcReactionBaseDmg(lvl), snap
}

func CalcCatalyzeDmg(lvl int, src reactionBonusSrc, atk info.AttackInfo, em float64) float64 {
	return (1 + ((5 * em) / (1200 + em)) + src.ReactBonus(atk)) * CalcReactionBaseDmg(lvl)
}

var reactionLvlBase = []float64{
	17.165606,
	18.535048,
	19.904854,
	21.274902,
	22.6454,
	24.649612,
	26.640642,
	28.868587,
	31.36768,
	34.143345,
	37.201,
	40.66,
	44.446667,
	48.56352,
	53.74848,
	59.081898,
	64.420044,
	69.72446,
	75.12314,
	80.58478,
	86.11203,
	91.70374,
	97.24463,
	102.812645,
	108.40956,
	113.20169,
	118.102905,
	122.97932,
	129.72733,
	136.29291,
	142.67085,
	149.02902,
	155.41699,
	161.8255,
	169.10631,
	176.51808,
	184.07274,
	191.70952,
	199.55692,
	207.38205,
	215.3989,
	224.16566,
	233.50217,
	243.35057,
	256.06308,
	268.5435,
	281.52606,
	295.01364,
	309.0672,
	323.6016,
	336.75754,
	350.5303,
	364.4827,
	378.61917,
	398.6004,
	416.39825,
	434.387,
	452.95105,
	472.60623,
	492.8849,
	513.56854,
	539.1032,
	565.51056,
	592.53876,
	624.4434,
	651.47015,
	679.4968,
	707.79407,
	736.67145,
	765.64026,
	794.7734,
	824.67737,
	851.1578,
	877.74207,
	914.2291,
	946.74677,
	979.4114,
	1011.223,
	1044.7917,
	1077.4437,
	1109.9976,
	1142.9766,
	1176.3695,
	1210.1844,
	1253.8357,
	1288.9528,
	1325.4841,
	1363.4569,
	1405.0974,
	1446.8535,
	1462.788,
	1475.6956,
	1497.9644,
	1516.9423,
	1561.468,
	1593.5062,
	1621.0258,
	1643.8679,
	1662.1382,
	1674.8092,
	2084.6357,
	2139.0503,
	2193.2134,
	2234.1733,
	2284.8242,
	2303.8215,
	2322.88,
	2341.9995,
	2361.1807,
	2380.4233,
	2399.7278,
	2419.0942,
	2438.5225,
	2458.0132,
	2491.481,
	2515.0237,
	2538.6436,
	2562.3406,
	2586.115,
	2609.9673,
	2633.8972,
	2657.905,
	2681.9912,
	2706.1558,
	2730.399,
	2740.8057,
	2751.238,
	2761.696,
	2772.1797,
	2782.689,
	2793.2239,
	2803.7847,
	2814.3713,
	2824.984,
	2835.6223,
	2846.2866,
	2856.9773,
	2867.6938,
	2878.4368,
	2889.2056,
	2900.001,
	2910.8225,
	2921.6704,
	2932.545,
	2943.4458,
	2954.3733,
	2965.3271,
	2976.3079,
	2987.3152,
	2998.3494,
	3009.4102,
	3020.498,
	3031.6128,
	3042.7544,
	3053.923,
	3065.119,
	3076.3418,
	3087.5918,
	3098.8691,
	3110.1738,
	3121.5056,
	3132.865,
	3144.252,
	3155.6663,
	3167.108,
	3178.5774,
	3190.0747,
	3201.5996,
	3213.152,
	3224.7327,
	3236.341,
	3247.9773,
	3259.6416,
	3271.334,
	3283.0544,
	3294.803,
	3306.5798,
	3318.3848,
	3330.218,
	3342.0798,
	3353.97,
	3365.8887,
	3377.8357,
	3389.8115,
	3401.816,
	3413.8489,
	3425.911,
	3438.0015,
	3450.1208,
	3462.2693,
	3474.4465,
	3486.6528,
	3498.8884,
	3511.1528,
	3523.4465,
	3535.623,
	3547.975,
	3560.3562,
	3572.7668,
	3585.207,
}
